<!-- SAME HTML HEAD AND STYLE CODE AS BEFORE -->

<body>
  <div class="container" id="formToPDF">
    <!-- Header & Title -->
    <img class="header-image" src="https://raw.githubusercontent.com/alkhooryengineering/ake/main/AKE%20LOGO%20(1).jpg" alt="Header" />
    <h1>AKE Vehicle Form</h1>

    <form id="VehicleForm">
      <!-- Vehicle -->
      <label for="vehicle">Vehicle:</label>
      <select id="vehicle" name="vehicle" onchange="toggleOtherField(this, 'vehicleOther')" required>
        <option value="" disabled selected>Select Vehicle</option>
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
        <option value="D">D</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="vehicleOther" name="vehicleOther" placeholder="Please specify" style="display:none;" />

      <!-- Odometer -->
      <label for="odometer">Odometer:</label>
      <input type="number" id="odometer" name="odometer" placeholder="Enter Odometer reading" max="9999999" required oninput="this.value=this.value.slice(0,7)" />

      <!-- Department -->
      <label>AKE Department:</label>
      <div class="radio-group">
        <label><input type="radio" name="ake_department" value="P&SS" onclick="toggleOtherDepartment(false)" required> P&SS</label>
        <label><input type="radio" name="ake_department" value="M.S" onclick="toggleOtherDepartment(false)" required> M.S</label>
        <label><input type="radio" name="ake_department" value="Other" onclick="toggleOtherDepartment(true)" required> Other</label>
      </div>
      <input type="text" id="otherDepartment" name="other_department" placeholder="Enter department name" style="display:none;" />

      <!-- Reason of Trip -->
      <label for="reason_of_trip">Reason of Trip:</label>
      <select id="reason_of_trip" name="reason_of_trip" onchange="toggleOtherField(this, 'reasonOther')" required>
        <option value="" disabled selected>Mention Reason of Trip</option>
        <option value="Pick&Drop">Pick&Drop</option>
        <option value="Repairing">Repairing</option>
        <option value="Delivery">Delivery</option>
        <option value="Personal Use">Personal Use</option>
        <option value="Site">Site</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="reasonOther" name="reasonOther" placeholder="Please specify" style="display:none;" />

      <!-- Date -->
      <label for="date_field">Date:</label>
      <input type="date" id="date_field" name="date_field" required />

      <!-- Driver Name -->
      <label for="driver_name">Driver Name:</label>
      <select id="driver_name" name="driver_name" onchange="toggleOtherField(this, 'driverOther')" required>
        <option value="" disabled selected>Select Driver</option>
        <option value="Sohail">Sohail</option>
        <option value="Amarjit">Amarjit</option>
        <option value="Aruna">Aruna</option>
        <option value="Ammar">Ammar</option>
        <option value="Senthil">Senthil</option>
        <option value="Other">Other</option>
      </select>
      <input type="text" id="driverOther" name="driverOther" placeholder="Please specify" style="display:none;" />

      <!-- Photos -->
      <label for="photosInput">Upload or Take Photos (up to 5):</label>
      <input type="file" id="photosInput" accept="image/*" multiple />
      <div id="photoPreview" style="display: flex; flex-wrap: wrap;"></div>

      <!-- Signature -->
      <label for="signature">Signature:</label>
      <canvas id="signature" class="signature-pad" required></canvas>

      <!-- Submit -->
      <button id="submitBtn" type="button" onclick="submitForm()">Submit</button>
      <div id="message" class="message"></div>
    </form>

    <footer>
      <section class="footer-contact">
        <p>P.O. Box:41, Dubai, UAE  Tel: +971 4 333 1317, Email: mahykeng@emirates.net.ae</p>
        <p>ISO 9001, 45001, 14001 CERTIFIED</p>
      </section>
    </footer>
  </div>

  <!-- Script -->
  <script>
    const signatureCanvas = document.getElementById("signature");
    const ctx = signatureCanvas.getContext("2d");
    let drawing = false;

    signatureCanvas.addEventListener("mousedown", () => drawing = true);
    signatureCanvas.addEventListener("mouseup", () => {
      drawing = false;
      ctx.beginPath();
    });
    signatureCanvas.addEventListener("mousemove", draw);
    signatureCanvas.addEventListener("touchstart", (e) => {
      e.preventDefault();
      drawing = true;
      drawTouch(e.touches[0]);
    });
    signatureCanvas.addEventListener("touchend", () => {
      drawing = false;
      ctx.beginPath();
    });
    signatureCanvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      drawTouch(e.touches[0]);
    });

    function draw(e) {
      if (!drawing) return;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.offsetX, e.offsetY);
    }

    function drawTouch(touch) {
      if (!drawing) return;
      const rect = signatureCanvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function toggleOtherDepartment(show) {
      document.getElementById("otherDepartment").style.display = show ? "block" : "none";
    }

    function toggleOtherField(selectElement, otherInputId) {
      const otherInput = document.getElementById(otherInputId);
      if (selectElement.value === "Other") {
        otherInput.style.display = "block";
        otherInput.required = true;
      } else {
        otherInput.style.display = "none";
        otherInput.required = false;
        otherInput.value = "";
      }
    }

    function getFinalValue(selectId, otherId) {
      const selectVal = document.getElementById(selectId).value;
      return selectVal === "Other" ? document.getElementById(otherId).value.trim() : selectVal;
    }

    let selectedPhotos = [];

    function previewImages() {
      const input = document.getElementById("photosInput");
      const files = Array.from(input.files);
      const previewDiv = document.getElementById("photoPreview");

      if ((selectedPhotos.length + files.length) > 5) {
        alert("You can only upload a maximum of 5 photos.");
        input.value = '';
        return;
      }

      selectedPhotos = selectedPhotos.concat(files);

      previewDiv.innerHTML = '';
      selectedPhotos.forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const imgElement = document.createElement("img");
          imgElement.src = e.target.result;
          previewDiv.appendChild(imgElement);
        };
        reader.readAsDataURL(file);
      });

      input.value = '';
    }

    document.getElementById("photosInput").addEventListener("change", previewImages);

    function validateForm() {
      const vehicle = getFinalValue("vehicle", "vehicleOther");
      const odometer = document.getElementById("odometer").value.trim();
      const department = document.querySelector('input[name="ake_department"]:checked')?.value;
      const otherDept = document.getElementById("otherDepartment").value.trim();
      const reason = getFinalValue("reason_of_trip", "reasonOther");
      const driver = getFinalValue("driver_name", "driverOther");
      const date = document.getElementById("date_field").value;
      const signatureData = ctx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height).data;

      if (!vehicle || !odometer || !department || !reason || !driver || !date) {
        alert("All fields are mandatory.");
        return false;
      }

      if (department === "Other" && !otherDept) {
        alert("Please specify the department.");
        return false;
      }

      let isSigned = false;
      for (let i = 0; i < signatureData.length; i += 4) {
        if (signatureData[i + 3] !== 0) {
          isSigned = true;
          break;
        }
      }

      if (!isSigned) {
        alert("Please provide a signature.");
        return false;
      }

      return true;
    }

    async function submitForm() {
      if (!validateForm()) return;

      const form = document.getElementById("VehicleForm");
      const formData = new FormData();
      const messageDiv = document.getElementById("message");

      formData.append("vehicle", getFinalValue("vehicle", "vehicleOther"));
      formData.append("odometer", document.getElementById("odometer").value.trim());

      const department = document.querySelector('input[name="ake_department"]:checked').value;
      formData.append("ake_department", department === "Other" ? document.getElementById("otherDepartment").value.trim() : department);

      formData.append("reason_of_trip", getFinalValue("reason_of_trip", "reasonOther"));
      formData.append("date_field", document.getElementById("date_field").value);
      formData.append("driver_name", getFinalValue("driver_name", "driverOther"));

      if (selectedPhotos.length === 0) {
        alert("Please upload at least one photo.");
        return;
      }

      selectedPhotos.forEach((file, index) => {
        formData.append("photo" + index, file);
      });

      const opt = {
        margin: 0,
        filename: 'vehicle_form.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      };

      html2pdf().set(opt).from(document.getElementById('formToPDF')).toPdf().get('pdf').then(async function (pdf) {
        const pdfBlob = pdf.output("blob");
        formData.append("pdf", pdfBlob, "vehicle_form.pdf");

        try {
          const response = await fetch("https://ake-form-backend.onrender.com/send-pdf", {
            method: "POST",
            body: formData
          });

          if (response.ok) {
            messageDiv.textContent = "✅ Email Delivered";
            messageDiv.style.color = "green";
            document.getElementById("submitBtn").style.display = "none";
          } else {
            messageDiv.textContent = "❌ Submission failed. Please try again.";
            messageDiv.style.color = "red";
          }
        } catch (error) {
          console.error("Error during submission:", error);
          messageDiv.textContent = "❌ Submission failed. Please try again.";
          messageDiv.style.color = "red";
        }
      });
    }
  </script>
</body>
</html>
