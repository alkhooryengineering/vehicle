<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Job Completion Report</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>








  
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .header-image {
      width: 90%;
      max-height: 80px;
      object-fit: contain;
      margin-bottom: 0px;
    }
    .grey-strip {
      background-color: #ccc;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      border-top: 2px solid #999;
      border-bottom: 2px solid #999;
    }
    .section {
      padding: 0 20px 20px 20px;
    }
    .info-heading {
      background-color: #ccc;
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border-top: 1px solid #aaa;
      border-bottom: 1px solid #aaa;
      margin-top: 20px;
    }
    .info-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background-color: #eee;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      margin: 0;
    }
    .info-block {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
    }
    .info-block label {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .horizontal-label {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .horizontal-label label {
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }
    .horizontal-label input[type="date"] {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #aaa;
      border-radius: 4px;
      background-color: white;
      flex: 1;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    td {
      border: 1px solid #ccc;
      vertical-align: top;
    }
    .left-col {
      width: 20%;
      font-weight: bold;
      padding: 10px;
      background-color: #f3f3f3;
    }
    .right-col {
      width: 80%;
      padding: 0;
    }
    .editable {
      padding: 10px;
      min-height: 120px;
      font-weight: bold;
      font-family: Arial, sans-serif;
      font-size: 14px;
      box-sizing: border-box;
      width: 100%;
      outline: none;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
    }
    .signature-area {
      background-color: #eee;
      padding: 15px;
      margin-top: 0;
    }
    .signature-strip {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      padding-bottom: 10px;
    }
    .signature-strip div {
      flex: 1;
    }
    .signature-strip input {
      width: 100%;
      padding: 6px;
    }
    .custom-table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }
    .custom-table td {
      border: 1px solid #aaa;
      padding: 8px;
    }
    .custom-table .narrow {
      width: 15%;
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .custom-table .wide input,
    .custom-table .wide select {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .signature-pad {
      border: 1px solid #aaa;
      width: 100%;
      height: 150px;
      margin-top: 0;
    }
    .photo-upload {
      margin: 30px 20px;
    }


.photo-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
}
    
    
  .photo-grid img {
  width: calc(33.333% - 10px); /* Three per row with gap compensation */
  max-width: 200px;             /* Optional: prevent overly large images */
  height: auto;
  border: 1px solid #ccc;
  object-fit: cover;
}

    
    }
    footer {
      background-color: #003366;
      color: white;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin: 40px 20px 20px 20px;
      font-size: 14px;
    }
    .submit-button {
      display: block;
      margin: 30px auto 0 auto;
      padding: 12px 30px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .submit-button:hover {
      background-color: #0056b3;
    }
    /*@media (max-width: 768px) {
      .info-row {
        flex-direction: column;
      }
      .horizontal-label {
        flex-direction: column;
        align-items: flex-start;
      }
      .horizontal-label input {
        width: 100%;
      }
      .signature-strip {
        flex-direction: column;
      }
      .photo-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      }
      .custom-table td {
        display: block;
        width: 100%;
        box-sizing: border-box;
      }
      .custom-table tr {
        display: block;
        margin-bottom: 15px;
      }
      .signature-area > div {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
    }*/



    
@media (max-width: 768px) {
  .custom-table {
    display: block;
    width: 100%;
    overflow-x: auto;
  }

  .custom-table tr {
    display: flex;
    flex-direction: column;
    width: 100%;
    margin-bottom: 10px;
  }

  .custom-table td {
    width: 100% !important;
    display: block;
    box-sizing: border-box;
  }

  .custom-table .narrow {
    background-color: #f5f5f5;
    font-weight: bold;
  }

  .signature-strip {
    flex-direction: column;
    align-items: stretch;
  }

  .signature-strip div {
    width: 100%;
  }

  .signature-area > div {
    flex-direction: column;
    gap: 20px;
  }

  .signature-area canvas {
    width: 100% !important;
  }

  .signature-area button {
    width: 100%;
  }
}

    

    
  </style>











  
</head>
<body>

<div class="container" id="formToPDF">
 <center> <img class="header-image" src="https://raw.githubusercontent.com/alkhooryengineering/ake/main/AKE%20LOGO%20(1).jpg" alt="Header" /> </center>
  <hr>

  <!-- Begin Form -->
  <form id="jobForm">
    <div class="section">
      <div class="grey-strip">ANNEXURE - SERVICE / JOB COMPLETION REPORT</div>

      <div class="info-heading">JOB INFORMATION</div>

      <div class="info-row">
        <div class="info-block">
          <label for="pr-po">PR/PO REFERENCE</label>
          <input type="text" id="pr-po" name="pr-po"  required />
        </div>
        <div class="info-block">
          <label for="facility-no">FACILITY NO.</label>
          <input type="text" id="facility-no" name="facility-no" required  />
        </div>
        <div class="info-block">
          <label for="facility-location">FACILITY LOCATION / ASSET NO</label>
          <input type="text" id="facility-location" name="facility-location" required />
        </div>
        <div class="info-block">
          <label for="fm-contact">FM POINT OF CONTACT (Name / Mobile No.)</label>
          <input type="text" id="fm-contact" name="fm-contact" required />
        </div>
      </div>

      <div class="info-row">
        <div class="horizontal-label" style="flex: 1; min-width: 100px;">
          <label for="date">DATE:</label>
          <input type="date" id="date" name="date" required />
        </div>
        <div class="horizontal-label" style="flex: 1; min-width: 100px;">
          <label for="site-visit-date">Site Visit / Inspection Date:</label>
          <input type="date" id="site-visit-date" name="site-visit-date" required />
        </div>
      </div>

      <div class="info-heading" style="margin-bottom: 0;">JOB DETAILS</div>

      <table>
        <tr> 
          <td class="left-col">Description</td>
          <td class="right-col">
            <div class="editable" contenteditable="true" name="description" data-required="true"></div>
          </td>
        </tr>
        <tr>
          <td class="left-col">Findings</td>
          <td class="right-col">
            <div class="editable" contenteditable="true" name="findings" data-required="true"></div>
          </td>
        </tr>
        <tr>
          <td class="left-col">Actions Required</td>
          <td class="right-col">
            <div class="editable" contenteditable="true" name="actionsRequired" data-required="true"></div>
          </td>
        </tr>
      </table>

  <br>

      <div class="signature-area">
        <div class="signature-strip">
          <div><center><b>Report Prepared By:</b> <input type="text" name="reportPreparedBy" required /></center></div>
          <div><center><b>Report Verified By:</b> <input type="text" name="reportVerifiedBy" /></center></div>
        </div>

        <table class="custom-table">
          <tr>
            <td class="narrow">Company Name</td> 
            <td class="wide">
              <select name="companyName" required>
                <option value="">Select</option>
                <option value="Al Khoory Engineering">Al Khoory Engineering</option>
                <option value="M.A.H.Y. Khoory">M.A.H.Y. Khoory</option>
                <option value="C.P.D">C.P.D</option>
                <option value="Other">Other</option>
              </select>
            </td>

            <td class="narrow">Verifier Company Name</td>
            <td class="wide"><input type="text" name="verifierCompanyName" /></td>
          </tr>

          <tr>
            <td class="narrow">Representative Name</td>
            <td class="wide">
              <select name="representativeName" required>
                <option value="">Select</option>
                <option value="Senthil Mariappan">Senthil Mariappan</option>
                <option value="Uday Achari">Uday Achari</option>
                <option value="Nurul Hassan">Nurul Hassan</option>
                <option value="Idrees Shaikh">Idrees Shaikh</option>
                <option value="Other">Other</option>
              </select>
            </td>

            <td class="narrow"></td>
            <td class="wide"><input type="text" name="otherRepresentative" /></td>
          </tr>

          <tr>
            <td class="narrow">Date</td>
            <td class="wide"><input type="date" name="verifiedDate" required /></td>
            <td class="narrow">Verified Date</td>
            <td class="wide"><input type="date" name="verifiedDate2" /></td>
          </tr>
        </table>



        
  <div class="signature-canvas-container" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; margin-top: 0;">

          <div>
            <br>
            <div style="margin-left: 50px;">
              <canvas id="sig1" class="signature-pad"></canvas>
              <center>
                <button type="button" onclick="clearSignature('sig1')">Clear AKE Sign</button>
              </center>
            </div>
          </div>

          <div>
            <br>
            <div style="margin-right: 50px;">
            <canvas id="sig2" class="signature-pad"></canvas>
            <center>
              <button type="button" onclick="clearSignature('sig2')">Clear Verifier Sign</button>
            </center>
          </div>
        </div>
       </div>

        

        <br><br>

        <center>
          <div class="photo-upload">
            <label><strong>Upload Photos:</strong></label>
            <input type="file" id="photoInput" multiple accept="image/*" />
            <div class="photo-grid" id="photoGrid" required></div>
          </div>
        </center>
      </div>

      <button id="submitBtn" type="submit" class="submit-button">Submit</button>
      <div id="message" style="text-align: center; margin-top: 20px;"></div>
    </div>
  </form>
  <!-- End Form -->

  <footer>
    <p>P.O. Box:41, Dubai, UAE  Tel: +971 4 333 1317, Email: mahykeng@emirates.net.ae</p>
    <p>ISO 9001, 45001, 14001 CERTIFIED</p>
  </footer>
</div>

<script>
  // Initialize Signature Pads on DOMContentLoaded
  document.addEventListener("DOMContentLoaded", function () {
    window.sigPad1 = new SignaturePad(document.getElementById("sig1"));
    window.sigPad2 = new SignaturePad(document.getElementById("sig2"));

    enableSignaturePad("sig1");
    enableSignaturePad("sig2");

    const photoInput = document.getElementById("photoInput");
    const photoGrid = document.getElementById("photoGrid");

    photoInput.addEventListener("change", function () {
      const files = Array.from(photoInput.files).slice(0, 9 - photoGrid.children.length);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement("img");
          img.src = e.target.result;
          photoGrid.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
      photoInput.value = '';
    });

    // Handle submit event
    const form = document.getElementById("jobForm");
    form.addEventListener("submit", submitForm);
  });

  function enableSignaturePad(id) {
    const canvas = document.getElementById(id);
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    window["sigPad" + (id === "sig1" ? "1" : "2")].clear();
  }

  function clearSignature(id) {
    if (id === "sig1") window.sigPad1.clear();
    else if (id === "sig2") window.sigPad2.clear();
  }

  // Helper: Convert signature canvas to Blob
  function getSignatureBlob(sigPad) {
    return new Promise(resolve => {
      if (sigPad.isEmpty()) resolve(null);
      else sigPad.canvas.toBlob(blob => resolve(blob));
    });
  }

  // Validate form inputs before submit
  function validateForm() {
    const form = document.getElementById("jobForm");
    if (!form.checkValidity()) {
      form.reportValidity();
      return false;
    }

    // Check required editable divs
    const editables = form.querySelectorAll(".editable[data-required='true']");
    for (const div of editables) {
      if (!div.textContent.trim()) {
        alert("Please fill all required text fields.");
        return false;
      }
    }

    // Check photo uploads
    const photoGrid = document.getElementById("photoGrid");
    if (photoGrid.children.length === 0) {
      alert("Please upload at least one photo.");
      return false;
    }

    // Check signature pads if needed (optional)
    // if (window.sigPad1.isEmpty()) {
    //   alert("Please provide the first signature.");
    //   return false;
    // }

    return true;
  }

  async function submitForm(event) {
    event.preventDefault();

    if (!validateForm()) return;

    const submitBtn = document.getElementById("submitBtn");
    submitBtn.disabled = true;

    const form = document.getElementById("jobForm");
    const formData = new FormData(form);

    // Append editable content (contenteditable divs)
    const editableDivs = form.querySelectorAll(".editable");
    editableDivs.forEach(div => {
      formData.append(div.getAttribute("name"), div.textContent.trim());
    });

    // Append signatures
    const sigBlob1 = await getSignatureBlob(window.sigPad1);
    const sigBlob2 = await getSignatureBlob(window.sigPad2);

    if (sigBlob1) formData.append("signature1.png", sigBlob1, "signature1.png");
    if (sigBlob2) formData.append("signature2.png", sigBlob2, "signature2.png");

    // Append photos as blobs from displayed images
    //const photoGrid = document.getElementById("photoGrid");
    // We do not have File objects stored separately, so we reconstruct blobs by fetching data URLs from images
    //for (let i = 0; i < photoGrid.children.length; i++) {
      //const img = photoGrid.children[i];
      //const dataURL = img.src;
      //const blob = dataURLtoBlob(dataURL);
      //formData.append("photo" + i + ".jpeg", blob, "photo" + i + ".jpeg");
    //}

    // PDF generation options
    const opt = {
      margin: 0,
      filename: 'job_completion_report.pdf',
      image: { type: 'jpeg', quality: 0.7 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    const messageDiv = document.getElementById("message");

    html2pdf().set(opt).from(document.getElementById('formToPDF')).toPdf().get('pdf').then(async function(pdf) {
      const pdfBlob = pdf.output("blob");
      formData.append("pdf", pdfBlob, "job_completion_report.pdf");

      try {
        const response = await fetch("https://ake-form-backend.onrender.com/send-pdf", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          messageDiv.textContent = "✅ Email Delivered";
          messageDiv.style.color = "green";
          submitBtn.style.display = "none";
        } else {
          messageDiv.textContent = "❌ Submission failed. Please try again.";
          messageDiv.style.color = "red";
          submitBtn.disabled = false;
        }
      } catch (error) {
        console.error("Submission error:", error);
        messageDiv.textContent = "❌ Submission failed. Please try again.";
        messageDiv.style.color = "red";
        submitBtn.disabled = false;
      }
    });
  }

  // Helper: Convert dataURL to Blob
  function dataURLtoBlob(dataurl) {
    const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
      bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
    for (let i = 0; i < n; i++) u8arr[i] = bstr.charCodeAt(i);
    return new Blob([u8arr], { type: mime });
  }
</script>

</body>
</html>
